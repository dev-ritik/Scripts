{% extends "base.html" %}
{% block title %}Chat Circles{% endblock %}
{% block content %}

<style>
    body {
        background: #fdf7ef;
        font-family: "Inter", sans-serif;
        text-align: center;
    }

    h1 {
        margin-top: 1rem;
        font-size: 2rem;
        font-weight: 700;
    }

    .dropdown {
        margin: 1rem 0 5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }

    .dropdown label {
        font-weight: 600;
        font-size: 1.1rem;
        color: #333;
    }

    #range {
        padding: 0.6rem 1rem;
        font-size: 1rem;
        border: 2px solid #ddd;
        border-radius: 12px;
        background: #fff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        cursor: pointer;
        outline: none;
    }

    #range:hover {
        border-color: #33b37a;
        box-shadow: 0 3px 8px rgba(51, 179, 122, 0.2);
    }

    #range:focus {
        border-color: #33b37a;
        box-shadow: 0 0 0 3px rgba(51, 179, 122, 0.2);
    }

    .custom-date-range {
        display: none;
        flex-direction: row;
        align-items: center;
        gap: 1rem;
        margin-top: 0.5rem;
        animation: fadeIn 0.3s ease;
    }

    .custom-date-range label {
        font-weight: 500;
        font-size: 0.95rem;
    }

    .custom-date-range input[type="date"] {
        padding: 0.4rem 0.6rem;
        font-size: 0.95rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fff;
        outline: none;
        transition: border-color 0.2s ease;
    }

    .custom-date-range input[type="date"]:focus {
        border-color: #33b37a;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .orbit-container {
        position: relative;
        width: 500px;
        height: 500px;
        margin: 0 auto;
    }

    .orbit {
        position: absolute;
        top: 50%;
        left: 50%;
        border: 2px dashed transparent;
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: spin 30s linear infinite;
        pointer-events: none
    }

    .orbit1 {
        width: 240px;
        height: 240px;
        border-color: #ff7d33;
        animation-duration: 20s;
    }

    .orbit2 {
        width: 400px;
        height: 400px;
        border-color: #ffd54a;
        animation-duration: 28s;
    }

    .orbit3 {
        width: 560px;
        height: 560px;
        border-color: #82b1ff;
        animation-duration: 36s;
    }

    @keyframes spin {
        from {
            transform: translate(-50%, -50%) rotate(0deg);
        }
        to {
            transform: translate(-50%, -50%) rotate(360deg);
        }
    }

    .orbit img {
        position: absolute;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        border: 3px solid white;
        object-fit: cover;
        transform: translate(-50%, -50%);
        transition: transform 0.3s;
        cursor: pointer;
        pointer-events: auto;
    }

    .orbit img:hover {
        transform: translate(-50%, -50%) scale(2);
    }

    .center-avatar {
        position: absolute; /* center it */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 120px;
        height: 120px;
        border-radius: 50%;
        overflow: hidden;
        border: 4px solid #33b37a;
        z-index: 2; /* keep it above orbits */
    }

    .center-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .common-words {
        margin-top: 2rem;
        background: rgba(255, 255, 255, 0.08);
        padding: 1.5rem;
        border-radius: 1rem;
        width: 90%;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        text-align: center;
        backdrop-filter: blur(8px);
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
    }

    .common-words h3 {
        margin-bottom: 1rem;
        color: #ffd54a;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-top: 20px;
    }

    canvas {
        width: 100%;
        height: 180px;
    }

    h4 {
        color: #aaa;
        font-weight: 500;
        margin-bottom: 8px;
    }

</style>

<h1>ðŸ’¬ Chat Circles</h1>

<div class="dropdown">
    <label for="range">ðŸ“… Select Range:</label>
    <select id="range">
        <option value="week">This Week</option>
        <option value="month">This Month</option>
        <option value="quarter">This Quarter</option>
        <option value="2026">2026</option>
        <option value="2025">2025</option>
        <option value="2024">2024</option>
        <option value="2023">2023</option>
        <option value="2022">2022</option>
        <option value="2021">2021</option>
        <option value="2020">2020</option>
        <option value="custom">Custom Range</option>
    </select>

    <div class="custom-date-range" id="customDateInputs">
        <label>From:</label>
        <input type="date" id="fromDate">
        <label>To:</label>
        <input type="date" id="toDate">
    </div>
</div>

<div class="orbit-container">
    <div class="center-avatar">
        <img alt="You" id="center-avatar">
    </div>

    <div class="orbit orbit1" id="orbit1"></div>
    <div class="orbit orbit2" id="orbit2"></div>
    <div class="orbit orbit3" id="orbit3"></div>
</div>

<div id="weekly-chart" style="width: 100%; height: 400px; margin-top: 40px;">
    <canvas id="weeklyLineChart"></canvas>
</div>

<div id="common-words" class="common-words">
    <h3>Most Common Words</h3>
    <div id="word-cloud-container" style="width: 100%; height: 300px;"></div>
</div>

<div id="msg-trends" class="msg-trends">
    <h3>Message Activity</h3>
    <div class="charts-grid">
        <div>
            <h4>Messages per Hour</h4>
            <canvas id="chart-hourly"></canvas>
        </div>
        <div>
            <h4>Messages per Day of Week</h4>
            <canvas id="chart-weekday"></canvas>
        </div>
        <div>
            <h4>Messages per Week</h4>
            <canvas id="chart-weekly"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    let start_date, end_date;
    const rangeSelect = document.getElementById("range");
    const customInputs = document.getElementById("customDateInputs");
    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");

    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Helper: get start & end dates for a preset range
    function getDateRange(range) {
        const today = new Date();
        let start, end;

        switch (range) {
            case "week":
                end = new Date(today);
                start = new Date();
                start.setDate(end.getDate() - 7);
                break;

            case "month":
                end = new Date(today);
                start = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
                break;

            case "quarter":
                end = new Date(today);
                start = new Date(today.getFullYear(), today.getMonth() - 3, today.getDate());
                break;

            case "2020":
            case "2021":
            case "2022":
            case "2023":
            case "2024":
            case "2025":
            case "2026":
                start = new Date(parseInt(range), 0, 1);
                end = new Date(parseInt(range), 11, 31);
                break;

            default:
                return null;
        }

        start_date = formatDate(start)
        end_date = formatDate(end)
        return {
            start_date: formatDate(start),
            end_date: formatDate(end),
        };
    }

    async function loadData() {
        const range = rangeSelect.value;

        let start_date = "", end_date = "";

        if (range === "custom") {
            const fromDate = document.getElementById("fromDate");
            const toDate = document.getElementById("toDate");

            start_date = fromDate.value;
            end_date = toDate.value;

            // âœ… If user hasnâ€™t selected both dates yet, stop here
            if (!start_date || !end_date) {
                console.log("Waiting for valid custom dates...");
                return;
            }

            // âœ… Optional: Validate logical order
            if (new Date(start_date) > new Date(end_date)) {
                console.warn("Invalid date range â€” start is after end.");
                return;
            }
        } else {
            const rangeData = getDateRange(range);
            if (rangeData) {
                start_date = rangeData.start_date;
                end_date = rangeData.end_date;
            } else {
                // fallback safety
                return;
            }
        }

        const query = new URLSearchParams({start_date, end_date}).toString();
        const res = await fetch(`/circle_data?${query}`);
        const data = await res.json();

        renderCircles(data.people);
        await renderMovingAverageChart(data.people)
    }

    async function renderMovingAverageChart(people) {
        if (movingAvgChart) {
            movingAvgChart.destroy();
            movingAvgChart = null;
        }
        // Extract labels (weeks)
        const allWeeks = Array.from(
            new Set(
                people.flatMap(p => Object.keys(p.chat_times.weekly_moving_avg))
            )
        ).sort();

        const ctx = document.getElementById("weeklyLineChart").getContext("2d");

        const top10People = people
            .sort((a, b) => b.chats - a.chats) // sort by chats descending
            .slice(0, 10);                     // take top 10

        const datasets = await Promise.all(
            top10People.map(async (p, idx) => {
                const avgMap = p.chat_times.weekly_moving_avg;
                const values = allWeeks.map(w => avgMap[w] || null);

                const color = `hsl(${(idx * 360 / people.length)}, 70%, 55%)`;

                return {
                    label: p.name,
                    data: values,
                    borderColor: color,
                    backgroundColor: color,
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                };
            })
        );

        movingAvgChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: allWeeks,
                datasets: datasets,
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: "nearest",
                    intersect: false,
                },
                plugins: {
                    legend: {display: false},
                    tooltip: {
                        callbacks: {
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.formattedValue}`,
                        },
                    },
                },
                scales: {
                    x: {
                        title: {display: true, text: "Week"},
                        grid: {display: false},
                    },
                    y: {
                        type: "logarithmic",
                        title: {display: true, text: "Messages (3-week avg)"},
                        beginAtZero: false,
                        ticks: {
                            callback: (val) => Number(val).toLocaleString(),
                        },
                    },
                },
            },
        });
    }

    function renderCircles(people) {
        // Clear previous avatars
        document.getElementById("orbit1").innerHTML = "";
        document.getElementById("orbit2").innerHTML = "";
        document.getElementById("orbit3").innerHTML = "";

        // Sort by chats descending
        people.sort((a, b) => b.chats - a.chats);

        const orbits = [
            {id: "orbit1", count: 3},
            {id: "orbit2", count: 5},
            {id: "orbit3", count: 7},
        ];

        let startIdx = 0;
        orbits.forEach((o) => {
            const orbit = document.getElementById(o.id);
            const count = o.count;
            for (let i = 0; i < count && startIdx < people.length; i++) {
                const person = people[startIdx++];
                const angle = (360 / count) * i;
                const img = document.createElement("img");
                img.src = person.dp;
                img.alt = person.name;
                img.title = `${person.name} (${person.chats} chats)`;
                img.style.top = `${50 - 50 * Math.cos((angle * Math.PI) / 180)}%`;
                img.style.left = `${50 + 50 * Math.sin((angle * Math.PI) / 180)}%`;

                img.addEventListener("click", () => {
                    updateCommonWords(person.name, start_date, end_date);
                });

                orbit.appendChild(img);
            }
        });
    }

    let charts = [];
    let movingAvgChart = null;
    async function updateCommonWords(name, start_date, end_date) {
        const container = document.getElementById("word-cloud-container");
        container.innerHTML = `<p style="color:#bbb">Loading ${name}'s words...</p>`;

        if (charts.length > 0) {
            charts.forEach(chart => chart.destroy());
            charts = [];
        }

        try {
            const query = new URLSearchParams({start_date, end_date}).toString();
            const res = await fetch(`/user/stats/${encodeURIComponent(name)}?${query}`);
            if (!res.ok) throw new Error("Network response not ok");
            const data = await res.json();

            const personWords = data.words || [];
            const perHour = data.per_hour || [];
            const perWeekday = data.per_weekday || [];
            const perWeek = data.per_week || [];

            container.innerHTML = "";

            if (personWords.length === 0) {
                container.innerHTML = `<p style="color:#ccc">No data available for ${name}</p>`;
                return;
            }

            // --- Word Cloud ---
            const maxFreq = Math.max(...personWords.map(([_, c]) => c));
            WordCloud(container, {
                list: personWords,
                gridSize: 8,
                weightFactor: s => (s / maxFreq) * 40 + 10,
                fontFamily: 'Impact, sans-serif',
                color: () => {
                    const colors = ['#ff6b6b', '#ffd93d', '#6bc5ff', '#b26bff', '#6bff95'];
                    return colors[Math.floor(Math.random() * colors.length)];
                },
                rotateRatio: 0.5,
                backgroundColor: 'transparent'
            });

            // --- Charts ---
            renderBarChart("chart-hourly", "Messages per Hour", perHour.labels, perHour.values);
            renderBarChart("chart-weekday", "Messages per Day", perWeekday.labels, perWeekday.values);
            renderBarChart("chart-weekly", "Messages per Week", perWeek.labels, perWeek.values);

        } catch (err) {
            console.error("Error fetching user stats:", err);
            container.innerHTML = `<p style="color:#f66">Failed to load data for ${name}</p>`;
        }
    }

    function renderBarChart(id, label, labels, data) {
        const ctx = document.getElementById(id);
        if (!ctx) return;

        charts.push(new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderRadius: 6,
                    borderSkipped: false,
                    backgroundColor: '#9aa0a6' // fallback before gradient applied
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        grid: {display: false},
                        ticks: {color: '#999'}
                    },
                    y: {
                        grid: {color: '#333'},
                        ticks: {color: '#777'}
                    }
                },
                plugins: {legend: {display: false}}
            },
            plugins: [{
                id: 'metalGradient',
                beforeDatasetsDraw(chart) {
                    const {ctx, chartArea} = chart;
                    if (!chartArea) return; // wait until chart area is ready

                    const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                    gradient.addColorStop(0, '#d7d9db');  // lighter metallic tone
                    gradient.addColorStop(0.5, '#a8aaad'); // mid-tone
                    gradient.addColorStop(1, '#5f6368');  // darker base

                    chart.data.datasets[0].backgroundColor = gradient;
                }
            }]
        }));
    }

    // Handle range selection
    rangeSelect.addEventListener("change", () => {
        if (rangeSelect.value === "custom") {
            customInputs.style.display = "flex";
        } else {
            customInputs.style.display = "none";
            loadData();
        }
    });

    // Handle custom date input
    toDate.addEventListener("change", () => {
        if (rangeSelect.value === "custom" && fromDate.value && toDate.value) {
            loadData();
        }
    });

    async function loadAdminUser() {
        const res = await fetch(`/user/admin`);
        const data = await res.json();
        const centerAvatar = document.getElementById("center-avatar");
        centerAvatar.src = '/user/dp/' + data.display_name;
        centerAvatar.addEventListener("click", () => {
            updateCommonWords(data.display_name, start_date, end_date);
        });

    }

    // Initial load
    loadData();
    loadAdminUser();

</script>

{% endblock %}
